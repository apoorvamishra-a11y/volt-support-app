const https = require('https');

const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTPr5ISAwyjMS34b5bGr-62D8CymWBRERe9P17NBFq90om0jViqbb0ubIxhq8m1zw/pub?gid=492068491&single=true&output=csv';

module.exports = (req, res) => {
  res.setHeader('Access-Control-Allow-Origin', '*');

  https.get(SHEET_URL, (response) => {
    let raw = '';
    response.on('data', chunk => raw += chunk);
    response.on('end', () => {
      try {
        const lines = raw.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.replace(/^"|"$/g, '').trim());
        const result = [];

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i];
          const values = [];
          let current = '';
          let inQuotes = false;

          for (let c = 0; c < line.length; c++) {
            if (line[c] === '"') {
              inQuotes = !inQuotes;
            } else if (line[c] === ',' && !inQuotes) {
              values.push(current.trim());
              current = '';
            } else {
              current += line[c];
            }
          }
          values.push(current.trim());

          const obj = {};
          headers.forEach((h, idx) => {
            obj[h] = (values[idx] || '').replace(/^"|"$/g, '').trim();
          });

          if (obj.type || obj.subType) result.push(obj);
        }

        res.status(200).json(result);
      } catch(e) {
        res.status(500).json({ error: 'Parsing failed: ' + e.message });
      }
    });
  }).on('error', (e) => {
    res.status(500).json({ error: 'Fetch failed: ' + e.message });
  });
};
